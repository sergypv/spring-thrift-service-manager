# spring-thrift-service-manager

Manage Thrift services through XML configuration

This little jar will allow you configure Thrift services using an xml or text driven configuration, there are two main advantages on this approach:

- Determine which services start on your application through configuration, no need to modify code
- Change the transport, ports, service implementation... all from the configuration

## Configuration

There are two pieces of configuration, services setup and server configuration. Both of them are specified at construction time.

### Server configuration

The server configuration provides both Server and Transport. thrift-service-manager requires of a factory for those in order to operate,
this need to be provided a construction time. The jar givesa two different servers out of the box but you can create in 5 minutes all the others (see below Using Other Servers).

* __ServiceThreadPoolWrapper__. This implementation is based on a TThreadedSelectorServer server (http://people.apache.org/~thejas/thrift-0.9/javadoc/org/apache/thrift/server/TThreadedSelectorServer.html) over a TNonblockingServerSocket transport layer (people.apache.org/~thejas/thrift-0.9/javadoc/org/apache/thrift/transport/TNonblockingServerSocket.html)
* __SecuredThreadPoolWrapper__. This implementation uses a public/private key pair in order to secure the server/client communication. It is based on a TThreadPoolServer server over a TSSLTransport transport layer.

#### Using Other Servers

Using any other combination of Server/Transport it's very easy. Implement _AbstractRunnableServiceWrapper_, including the factory inner class, and you are good to go. 
There is only one mandatory method: _getServer_, which should return the server you want to use. The Factory class should returns the a new instance of it each time _getServiceWrapper_ is invoked.
 
Just copy _ServiceThreadPoolWrapper_ as an starting point and go from there. If you do so, please contribute by providing the code as a Pull Request.

### Service setup

The are two ways to initialize services with thrift-service-manager, through XML configuration and csv lists.
On both cases you need to provide the configuration at construction time.

#### XML Configuration

Create an serviceConfiguration.xml file, such as follow

```XML
<?xml version="1.0" encoding="UTF-8" standalone="no" ?>

<thirftServiceConfiguration xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:noNamespaceSchemaLocation="thriftServiceDefinition.xsd">
	<service name="MathService" port="10904">
		<serviceDefinition interface="org.sergilos.servicemanager.remote.test.MathTestServiceAddition" implementation="org.sergilos.servicemanager.remote.test.MathServiceAdditionImpl" />
		<serviceDefinition interface="org.sergilos.servicemanager.remote.test.MathTestServiceSubtraction" implementation="org.sergilos.servicemanager.remote.test.MathServiceSubtractionImpl" />
	</service>
	<service name="ThreadService" port="10905">
		<serviceDefinition interface="org.sergilos.servicemanager.remote.test.ThreadTestService" implementation="org.sergilos.servicemanager.remote.test.ThreadServiceImpl" />
	</service>
</thirftServiceConfiguration>
```

The above configuration defines three services, two of them (Addition and Subtraction) on the port 10904 and the third on 10905

To start the service just specify the configuration file at construction time:

```java
ServiceManager serviceManager = new ServiceManager("/whatever/your/path/is/testServiceConfiguration.xml", new ServiceThreadPoolWrapper.ServiceThreadPoolWrapperFactory(1, 1));
serviceManager.startupServer();
```

#### CSV Configuration

You need to provide 4 csv strings:

* __Service Names__: The name of the services 
* __Service Interfaces__: Thrift interfaces (autogenerated code)
* __Services Implementations__: The implementations for the interfaces
* __Ports__: The ports used. Notice that you can group several services in one single port (you can setup all the services in the same port if you want). This is because we are using TMultiplexedProtocol (a protocol decorator).

Example:

```java
String serviceNames = "MathService,MathService,ThreadService";
String serviceInterfaces = SERVICE_PACKAGE + ".MathTestServiceAddition," + SERVICE_PACKAGE + ".MathTestServiceSubtraction," + SERVICE_PACKAGE + ".ThreadTestService";
String serviceImplementations = SERVICE_PACKAGE + ".MathServiceAdditionImpl," + SERVICE_PACKAGE + ".MathServiceSubtractionImpl," + SERVICE_PACKAGE + ".ThreadServiceImpl";
String servicePorts = "10902,10902,10903";

serviceManager = new ServiceManager(serviceNames, serviceInterfaces, serviceImplementations, servicePorts, true, new ServiceThreadPoolWrapper.ServiceThreadPoolWrapperFactory(1, 1));
```

### Spring Autowiring

If you are using Spring in your project you can take advantage of the dependency injection capabilities that come with it. Simply use the _@Autowired_ annotation in your services implementation and setup the _applicationContext_ in the _ServiceManager_.

Example:

```XML
<bean id="ServiceManager" class="org.sergilos.servicemanager.ServiceManager" destroy-method="stopServices" init-method="startupServer">
    <constructor-arg name="xmlConfigurationLocation" value="/path/to/xml/config"/>
</bean>
```

## Client side

Example code to start using your services once it is up:

```java
TTransport transport = new TFramedTransport(new TSocket("localhost", 10904));
transport.open();

TProtocol protocol = new TBinaryProtocol(transport);
TMultiplexedProtocol multiplexProtocolAddition = new TMultiplexedProtocol(protocol, "org.sergilos.servicemanager.remote.test.MathTestServiceAddition");
MathTestServiceAddition.Client mathAdditionClient = new MathTestServiceAddition.Client(multiplexProtocolAddition);

int result = mathAdditionClient.testingSum(100, 200);
```